{% extends "layout.html" %}

{% block title %}Chỉnh sửa {{ user.display_name }}{% endblock %}

{% block content %}

<div class="page-header-actions">
    <a href="{{ url_for('members', guild_id=guild.id) }}" class="poetic-button poetic-button-secondary">&larr; Quay lại danh sách</a>
</div>

<div class="poetic-card">
    <div class="poetic-card-header edit-member-header">
        <img src="{{ user.avatar_url }}" alt="Avatar">
        <h2 class="poetic-header" style="margin:0; text-align: left;">Sửa: {{ user.display_name }}</h2>
    </div>
    <div class="poetic-card-body">
        <form method="POST">
            <h5 class="form-section-title">Thông tin chung</h5>
            <div class="form-grid">
                <div class="form-group-poetic">
                    <label for="balance" class="form-label-poetic">Số dư Coin</label>
                    <input type="number" class="form-control-poetic" id="balance" name="balance" value="{{ user.balance }}">
                </div>
                <div class="form-group-poetic">
                    <label for="fake_boosts" class="form-label-poetic">Số lượng Boost "ảo"</label>
                    <input type="number" class="form-control-poetic" id="fake_boosts" name="fake_boosts" value="{{ user.fake_boosts or 0 }}" min="0">
                    <div class="form-text-poetic">Đặt > 0 để ghi đè số boost thật khi tính hệ số nhân.</div>
                </div>
            </div>

            {% if user.role_id %}
            <hr>
            <h5 class="form-section-title">Role Tùy Chỉnh</h5>
            <div class="form-grid">
                <div class="form-group-poetic">
                    <label class="form-label-poetic">Role ID</label>
                    <input type="text" class="form-control-poetic" value="{{ user.role_id }}" disabled>
                </div>
                 <div class="form-group-poetic">
                    <label for="role_name" class="form-label-poetic">Tên Role</label>
                    <input type="text" class="form-control-poetic" id="role_name" name="role_name" value="{{ user.role_name }}">
                </div>
                 <div class="form-group-poetic">
                    <label for="role_color" class="form-label-poetic">Màu Role (HEX)</label>
                    <input type="text" class="form-control-poetic" id="role_color" name="role_color" value="{{ user.role_color }}">
                </div>
            </div>
            {% endif %}
            
            <div class="form-actions">
                <a href="{{ url_for('members', guild_id=guild.id) }}" class="poetic-button poetic-button-secondary">Hủy</a>
                <button type="submit" class="poetic-button poetic-button-primary">Lưu thay đổi</button>
            </div>
        </form>

        {% if transactions %}
        <hr>
        <h5 class="form-section-title">Lịch sử Giao dịch Gần đây</h5>
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
             <table class="history-table">
                <thead>
                    <tr>
                        <th>Loại</th>
                        <th>Chi tiết</th>
                        <th>Thay đổi</th>
                        <th>Số dư mới</th>
                        <th>Thời gian</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in transactions %}
                    <tr>
                        <td>{{ t.transaction_type }}</td>
                        <td>{{ t.item_name or 'N/A' }}</td>
                        <td style="color: {% if t.amount_changed > 0 %}var(--success-color){% else %}var(--danger-color){% endif %};">
                            {% if t.amount_changed > 0 %}+{% endif %}{{ "{:,}".format(t.amount_changed) }}
                        </td>
                        <td>{{ "{:,}".format(t.new_balance) }}</td>
                        <td><small>{{ t.timestamp.strftime('%Y-%m-%d %H:%M') }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>
<style>
.history-table { width: 100%; border-collapse: collapse; }
.history-table th, .history-table td { padding: 0.8rem 1rem; text-align: left; border-bottom: 1px solid rgba(var(--border-color-rgb), 0.2); }
.history-table th { font-weight: 500; color: var(--highlight-color-poetic); }
.history-table tbody tr:last-child td { border-bottom: none; }
.history-table tbody tr:hover { background-color: rgba(var(--highlight-color-poetic-rgb), 0.05); }
</style>
{% endblock %}