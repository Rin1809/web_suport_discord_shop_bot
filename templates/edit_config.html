{% extends "layout.html" %}

{% block title %}Chỉnh sửa Server {{ guild_id }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Chỉnh sửa cấu hình cho Server ID: {{ guild_id }}</h2>
    </div>
    <div class="card-body">
        <form method="POST" id="config-form">
            <!-- Nav tabs -->
            <ul class="nav nav-tabs" id="configTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true">Cài đặt chung</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="messages-tab" data-bs-toggle="tab" data-bs-target="#messages" type="button" role="tab" aria-controls="messages" aria-selected="false">Tin nhắn & Embeds</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="rates-tab" data-bs-toggle="tab" data-bs-target="#rates" type="button" role="tab" aria-controls="rates" aria-selected="false">Tỷ lệ Coin</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="customrole-tab" data-bs-toggle="tab" data-bs-target="#customrole" type="button" role="tab" aria-controls="customrole" aria-selected="false">Role Tùy Chỉnh</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="qna-tab" data-bs-toggle="tab" data-bs-target="#qna" type="button" role="tab" aria-controls="qna" aria-selected="false">Q&A</button>
                </li>
            </ul>

            <!-- Tab content -->
            <div class="tab-content border border-top-0 p-3" id="configTabContent">
                <!-- General Tab -->
                <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                    <div class="mb-3">
                        <label for="shop_channel_id" class="form-label">ID Kênh Shop</label>
                        <input type="number" class="form-control" id="shop_channel_id" name="shop_channel_id" value="{{ config.shop_channel_id or '' }}" required>
                        <div class="form-text">ID của kênh text nơi bot sẽ gửi bảng điều khiển shop.</div>
                    </div>
                    <div class="mb-3">
                        <label for="leaderboard_thread_id" class="form-label">ID Thread Bảng Xếp Hạng</label>
                        <input type="number" class="form-control" id="leaderboard_thread_id" name="leaderboard_thread_id" value="{{ config.leaderboard_thread_id or '' }}">
                        <div class="form-text">ID của thread BXH (thường được bot tự điền).</div>
                    </div>
                    <div class="mb-3">
                        <label for="embed_color" class="form-label">Màu Embed (HEX)</label>
                        <input type="text" class="form-control" id="embed_color" name="EMBED_COLOR" value="{{ config.get('EMBED_COLOR', '#ff00af') }}" placeholder="#ff00af">
                    </div>
                     <div class="mb-3">
                        <label for="refund_percentage" class="form-label">Tỷ lệ hoàn tiền khi bán role (%)</label>
                        <input type="number" step="0.01" class="form-control" id="refund_percentage" name="SELL_REFUND_PERCENTAGE" value="{{ config.get('SELL_REFUND_PERCENTAGE', 0.65) }}">
                        <div class="form-text">Ví dụ: 0.65 tương đương hoàn lại 65% giá trị.</div>
                    </div>
                </div>

                <!-- Messages & Embeds Tab -->
                <div class="tab-pane fade" id="messages" role="tabpanel" aria-labelledby="messages-tab">
                    
                    <h5 class="mt-3">Embed Shop Chính</h5>
                    <div class="mb-3">
                        <label class="form-label">Tiêu đề</label>
                        <input type="text" class="form-control" name="MESSAGES[SHOP_EMBED_TITLE]" value="{{ config.MESSAGES.get('SHOP_EMBED_TITLE', 'Shop Role') }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" name="MESSAGES[SHOP_EMBED_DESCRIPTION]" rows="3">{{ config.MESSAGES.get('SHOP_EMBED_DESCRIPTION', 'Chào mừng') }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">URL Thumbnail</label>
                        <input type="url" class="form-control" name="SHOP_EMBED_THUMBNAIL_URL" value="{{ config.get('SHOP_EMBED_THUMBNAIL_URL', '') }}">
                    </div>
                     <div class="mb-3">
                        <label class="form-label">URL Ảnh Lớn</label>
                        <input type="url" class="form-control" name="SHOP_EMBED_IMAGE_URL" value="{{ config.get('SHOP_EMBED_IMAGE_URL', '') }}">
                    </div>
                    <hr/>

                    <h5 class="mt-3">Embed Thông Tin Tài Khoản</h5>
                     <div class="mb-3">
                        <label class="form-label">Tiêu đề</label>
                        <input type="text" class="form-control" name="MESSAGES[ACCOUNT_INFO_TITLE]" value="{{ config.MESSAGES.get('ACCOUNT_INFO_TITLE', '') }}">
                    </div>
                     <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" name="MESSAGES[ACCOUNT_INFO_DESC]" rows="2">{{ config.MESSAGES.get('ACCOUNT_INFO_DESC', '') }}</textarea>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label class="form-label">Tên trường "Số dư"</label>
                            <input type="text" class="form-control" name="MESSAGES[BALANCE_FIELD_NAME]" value="{{ config.MESSAGES.get('BALANCE_FIELD_NAME', 'Số Dư Hiện Tại') }}">
                        </div>
                        <div class="col">
                            <label class="form-label">Giá trị trường "Số dư"</label>
                            <input type="text" class="form-control" name="MESSAGES[BALANCE_FIELD_VALUE]" value="{{ config.MESSAGES.get('BALANCE_FIELD_VALUE', '{balance} coin') }}">
                             <div class="form-text">Sử dụng <code>{balance}</code> để chèn số dư.</div>
                        </div>
                    </div>
                    <hr/>

                    <h5 class="mt-3">Embed Tỷ lệ kiếm coin</h5>
                     <div class="mb-3">
                        <label class="form-label">Tiêu đề</label>
                        <input type="text" class="form-control" name="MESSAGES[EARNING_RATES_TITLE]" value="{{ config.MESSAGES.get('EARNING_RATES_TITLE', '') }}">
                    </div>
                     <div class="mb-3">
                        <label class="form-label">Mô tả chính</label>
                        <textarea class="form-control" name="MESSAGES[EARNING_RATES_DESC]" rows="2">{{ config.MESSAGES.get('EARNING_RATES_DESC', '') }}</textarea>
                    </div>
                     <div class="mb-3">
                        <label class="form-label">Nội dung ưu đãi Booster</label>
                        <textarea class="form-control" name="MESSAGES[BOOSTER_MULTIPLIER_INFO]" rows="4">{{ config.MESSAGES.get('BOOSTER_MULTIPLIER_INFO', '') }}</textarea>
                    </div>
                     <div class="mb-3">
                        <label class="form-label">URL Ảnh</label>
                        <input type="url" class="form-control" name="EARNING_RATES_IMAGE_URL" value="{{ config.get('EARNING_RATES_IMAGE_URL', '') }}">
                    </div>
                    <hr/>

                    <h5 class="mt-3">Embed Danh Sách Role</h5>
                     <div class="mb-3">
                        <label class="form-label">Tiêu đề</label>
                        <input type="text" class="form-control" name="MESSAGES[SHOP_ROLES_TITLE]" value="{{ config.MESSAGES.get('SHOP_ROLES_TITLE', '') }}">
                    </div>
                     <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                         <textarea class="form-control" name="MESSAGES[SHOP_ROLES_DESC]" rows="2">{{ config.MESSAGES.get('SHOP_ROLES_DESC', '') }}</textarea>
                    </div>
                     <div class="mb-3">
                        <label class="form-label">Thông báo khi shop trống</label>
                         <input type="text" class="form-control" name="MESSAGES[SHOP_ROLES_EMPTY]" value="{{ config.MESSAGES.get('SHOP_ROLES_EMPTY', '') }}">
                    </div>
                    <hr/>

                    <h5 class="mt-3">Tin Nhắn Chức Năng Role Tùy Chỉnh</h5>
                     <div class="mb-3">
                        <label class="form-label">Lời nhắc quản lý</label>
                         <textarea class="form-control" name="MESSAGES[CUSTOM_ROLE_MANAGE_PROMPT]" rows="2">{{ config.MESSAGES.get('CUSTOM_ROLE_MANAGE_PROMPT', '') }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Thông báo không đủ boost</label>
                         <textarea class="form-control" name="MESSAGES[CUSTOM_ROLE_NO_BOOSTS]" rows="2">{{ config.MESSAGES.get('CUSTOM_ROLE_NO_BOOSTS', '') }}</textarea>
                         <div class="form-text">Sử dụng <code>{min_boosts}</code> và <code>{boost_count}</code>.</div>
                    </div>
                     <div class="mb-3">
                        <label class="form-label">Thông báo đã sở hữu role</label>
                         <textarea class="form-control" name="MESSAGES[CUSTOM_ROLE_ALREADY_OWNED]" rows="2">{{ config.MESSAGES.get('CUSTOM_ROLE_ALREADY_OWNED', '') }}</textarea>
                    </div>
                     <div class="mb-3">
                        <label class="form-label">Thông báo không đủ coin</label>
                         <textarea class="form-control" name="MESSAGES[CUSTOM_ROLE_NO_COIN]" rows="2">{{ config.MESSAGES.get('CUSTOM_ROLE_NO_COIN', '') }}</textarea>
                         <div class="form-text">Sử dụng <code>{price}</code> và <code>{balance}</code>.</div>
                    </div>
                     <div class="mb-3">
                        <label class="form-label">Thông báo chưa sở hữu role</label>
                         <textarea class="form-control" name="MESSAGES[CUSTOM_ROLE_NOT_OWNED]" rows="2">{{ config.MESSAGES.get('CUSTOM_ROLE_NOT_OWNED', '') }}</textarea>
                    </div>
                    <hr/>

                    <h5 class="mt-3">Tin Nhắn Chân Trang (Footer)</h5>
                    <div class="mb-3">
                        <label class="form-label">Bảng điều khiển Shop</label>
                        <input type="text" class="form-control" name="FOOTER_MESSAGES[SHOP_PANEL]" value="{{ config.FOOTER_MESSAGES.get('SHOP_PANEL', '') }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Thông tin tài khoản</label>
                        <input type="text" class="form-control" name="FOOTER_MESSAGES[ACCOUNT_INFO]" value="{{ config.FOOTER_MESSAGES.get('ACCOUNT_INFO', '') }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tỷ lệ kiếm coin</label>
                        <input type="text" class="form-control" name="FOOTER_MESSAGES[EARNING_RATES]" value="{{ config.FOOTER_MESSAGES.get('EARNING_RATES', '') }}">
                    </div>
                     <div class="mb-3">
                        <label class="form-label">Danh sách role</label>
                        <input type="text" class="form-control" name="FOOTER_MESSAGES[ROLE_LIST]" value="{{ config.FOOTER_MESSAGES.get('ROLE_LIST', '') }}">
                    </div>
                </div>

                <!-- Rates Tab -->
                <div class="tab-pane fade" id="rates" role="tabpanel" aria-labelledby="rates-tab">
                    <h5 class="mt-3">Tỷ lệ mặc định</h5>
                    <div class="row">
                        <div class="col">
                            <label class="form-label">Tin nhắn / 1 coin</label>
                            <input type="number" class="form-control" name="CURRENCY_RATES[default][MESSAGES_PER_COIN]" value="{{ config.CURRENCY_RATES.default.get('MESSAGES_PER_COIN', '') }}">
                        </div>
                        <div class="col">
                            <label class="form-label">Reaction / 1 coin</label>
                            <input type="number" class="form-control" name="CURRENCY_RATES[default][REACTIONS_PER_COIN]" value="{{ config.CURRENCY_RATES.default.get('REACTIONS_PER_COIN', '') }}">
                        </div>
                    </div>

                    <hr>
                    <h5 class="mt-3">Tỷ lệ riêng cho Danh mục (Category)</h5>
                    <div id="category-rates-container">
                        {% for cat_id, rates in config.CURRENCY_RATES.categories.items() %}
                        <div class="row mb-2 align-items-center dynamic-row">
                            <div class="col-md-4"><input type="number" class="form-control" name="category_rate_id[]" value="{{ cat_id }}" placeholder="ID Danh mục"></div>
                            <div class="col-md-3"><input type="number" class="form-control" name="category_rate_messages[]" value="{{ rates.MESSAGES_PER_COIN or '' }}" placeholder="Tin nhắn / coin"></div>
                            <div class="col-md-3"><input type="number" class="form-control" name="category_rate_reactions[]" value="{{ rates.REACTIONS_PER_COIN or '' }}" placeholder="Reaction / coin"></div>
                            <div class="col-md-2"><button type="button" class="btn btn-danger btn-sm w-100" onclick="removeRow(this)">Xóa</button></div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-outline-success mt-2" onclick="addCategoryRate()">Thêm tỷ lệ Danh mục</button>

                    <hr>
                    <h5 class="mt-3">Tỷ lệ riêng cho Kênh</h5>
                    <div id="channel-rates-container">
                         {% for chan_id, rates in config.CURRENCY_RATES.channels.items() %}
                        <div class="row mb-2 align-items-center dynamic-row">
                            <div class="col-md-4"><input type="number" class="form-control" name="channel_rate_id[]" value="{{ chan_id }}" placeholder="ID Kênh"></div>
                            <div class="col-md-3"><input type="number" class="form-control" name="channel_rate_messages[]" value="{{ rates.MESSAGES_PER_COIN or '' }}" placeholder="Tin nhắn / coin"></div>
                            <div class="col-md-3"><input type="number" class="form-control" name="channel_rate_reactions[]" value="{{ rates.REACTIONS_PER_COIN or '' }}" placeholder="Reaction / coin"></div>
                            <div class="col-md-2"><button type="button" class="btn btn-danger btn-sm w-100" onclick="removeRow(this)">Xóa</button></div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-outline-success mt-2" onclick="addChannelRate()">Thêm tỷ lệ Kênh</button>
                </div>

                <!-- Custom Role Tab -->
                <div class="tab-pane fade" id="customrole" role="tabpanel" aria-labelledby="customrole-tab">
                    <h5 class="mt-3">Cài đặt Role Tùy Chỉnh (cho Booster)</h5>
                     <div class="mb-3">
                        <label class="form-label">Số lần boost tối thiểu</label>
                        <input type="number" class="form-control" name="CUSTOM_ROLE_CONFIG[MIN_BOOST_COUNT]" value="{{ config.CUSTOM_ROLE_CONFIG.get('MIN_BOOST_COUNT', 2) }}">
                    </div>
                     <div class="mb-3">
                        <label class="form-label">Giá (coin)</label>
                        <input type="number" class="form-control" name="CUSTOM_ROLE_CONFIG[PRICE]" value="{{ config.CUSTOM_ROLE_CONFIG.get('PRICE', 1000) }}">
                    </div>
                </div>

                <!-- Q&A Tab -->
                <div class="tab-pane fade" id="qna" role="tabpanel" aria-labelledby="qna-tab">
                    <h5 class="mt-3">Câu hỏi thường gặp</h5>
                    <div id="qna-container">
                        {% for item in config.get('QNA_DATA', []) %}
                        <div class="border p-2 mb-2 dynamic-row">
                            <div class="row">
                                <div class="col-md-5 mb-2"><input type="text" class="form-control" name="qna_label[]" placeholder="Câu hỏi (hiện trên menu)" value="{{ item.label }}"></div>
                                <div class="col-md-5 mb-2"><input type="text" class="form-control" name="qna_description[]" placeholder="Mô tả ngắn (hiện dưới câu hỏi)" value="{{ item.description or '' }}"></div>
                                <div class="col-md-2 mb-2"><input type="text" class="form-control" name="qna_emoji[]" placeholder="Emoji" value="{{ item.emoji or '' }}"></div>
                            </div>
                            <div class="row">
                                <div class="col-md-10 mb-2"><input type="text" class="form-control" name="qna_answer_title[]" placeholder="Tiêu đề câu trả lời" value="{{ item.answer_title or '' }}"></div>
                                <div class="col-md-2 mb-2"><button type="button" class="btn btn-danger btn-sm w-100" onclick="removeRow(this)">Xóa</button></div>
                            </div>
                            <textarea class="form-control" name="qna_answer_description[]" rows="3" placeholder="Nội dung câu trả lời">{{ item.answer_description or '' }}</textarea>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-outline-success mt-2" onclick="addQnA()">Thêm Q&A</button>
                </div>
            </div>
            
            <div class="mt-4">
                <a href="{{ url_for('index') }}" class="btn btn-secondary">Hủy</a>
                <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
            </div>
        </form>
    </div>
</div>

<script>
function removeRow(button) {
    button.closest('.dynamic-row').remove();
}

function addCategoryRate() {
    const container = document.getElementById('category-rates-container');
    const newRow = document.createElement('div');
    newRow.className = 'row mb-2 align-items-center dynamic-row';
    newRow.innerHTML = `
        <div class="col-md-4"><input type="number" class="form-control" name="category_rate_id[]" placeholder="ID Danh mục"></div>
        <div class="col-md-3"><input type="number" class="form-control" name="category_rate_messages[]" placeholder="Tin nhắn / coin"></div>
        <div class="col-md-3"><input type="number" class="form-control" name="category_rate_reactions[]" placeholder="Reaction / coin"></div>
        <div class="col-md-2"><button type="button" class="btn btn-danger btn-sm w-100" onclick="removeRow(this)">Xóa</button></div>
    `;
    container.appendChild(newRow);
}

function addChannelRate() {
    const container = document.getElementById('channel-rates-container');
    const newRow = document.createElement('div');
    newRow.className = 'row mb-2 align-items-center dynamic-row';
    newRow.innerHTML = `
        <div class="col-md-4"><input type="number" class="form-control" name="channel_rate_id[]" placeholder="ID Kênh"></div>
        <div class="col-md-3"><input type="number" class="form-control" name="channel_rate_messages[]" placeholder="Tin nhắn / coin"></div>
        <div class="col-md-3"><input type="number" class="form-control" name="channel_rate_reactions[]" placeholder="Reaction / coin"></div>
        <div class="col-md-2"><button type="button" class="btn btn-danger btn-sm w-100" onclick="removeRow(this)">Xóa</button></div>
    `;
    container.appendChild(newRow);
}

function addQnA() {
    const container = document.getElementById('qna-container');
    const newRow = document.createElement('div');
    newRow.className = 'border p-2 mb-2 dynamic-row';
    newRow.innerHTML = `
        <div class="row">
            <div class="col-md-5 mb-2"><input type="text" class="form-control" name="qna_label[]" placeholder="Câu hỏi (hiện trên menu)"></div>
            <div class="col-md-5 mb-2"><input type="text" class="form-control" name="qna_description[]" placeholder="Mô tả ngắn (hiện dưới câu hỏi)"></div>
            <div class="col-md-2 mb-2"><input type="text" class="form-control" name="qna_emoji[]" placeholder="Emoji"></div>
        </div>
        <div class="row">
            <div class="col-md-10 mb-2"><input type="text" class="form-control" name="qna_answer_title[]" placeholder="Tiêu đề câu trả lời"></div>
            <div class="col-md-2 mb-2"><button type="button" class="btn btn-danger btn-sm w-100" onclick="removeRow(this)">Xóa</button></div>
        </div>
        <textarea class="form-control" name="qna_answer_description[]" rows="3" placeholder="Nội dung câu trả lời"></textarea>
    `;
    container.appendChild(newRow);
}
</script>
{% endblock %}