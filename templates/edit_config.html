{% extends "layout.html" %}

{% block title %}Chỉnh sửa Server {{ guild.name or guild_id }}{% endblock %}

{% block content %}
<div class="poetic-card">
    <div class="poetic-card-header">
        <h2 class="poetic-header">Chỉnh sửa: {{ guild.name or guild_id }}</h2>
    </div>
    <div class="poetic-card-body">
        <form method="POST" id="config-form">
            <div class="config-nav" id="configTabNav">
                <button class="config-nav-button active" data-target="#general" type="button">Cài đặt chung</button>
                <button class="config-nav-button" data-target="#messages" type="button">Tin nhắn & Embeds</button>
                <button class="config-nav-button" data-target="#rates" type="button">Tỷ lệ Coin</button>
                <button class="config-nav-button" data-target="#customrole" type="button">Role Tùy Chỉnh</button>
                <button class="config-nav-button" data-target="#qna" type="button">Q&A</button>
            </div>

            <div class="tab-content" id="configTabContent">
                <div class="tab-pane active" id="general">
                    <div class="dynamic-row-grid">
                        <div class="form-group-poetic">
                            <label for="shop_channel_id" class="form-label-poetic">Kênh Shop</label>
                            <select class="form-select-poetic" id="shop_channel_id" name="shop_channel_id" required>
                                <option value="">-- Chọn một kênh --</option>
                                {% for channel in text_channels %}
                                    <option value="{{ channel.id }}" {% if channel.id|string == config.shop_channel_id|string %}selected{% endif %}>
                                        #{{ channel.name }} (ID: {{ channel.id }})
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text-poetic">Kênh bot sẽ gửi bảng điều khiển shop.</div>
                        </div>
                        <div class="form-group-poetic">
                            <label for="leaderboard_thread_id" class="form-label-poetic">ID Thread Bảng Xếp Hạng</label>
                            <input type="number" class="form-control-poetic" id="leaderboard_thread_id" name="leaderboard_thread_id" value="{{ config.leaderboard_thread_id or '' }}">
                            <div class="form-text-poetic">ID của thread BXH (thường được bot tự điền).</div>
                        </div>
                        <div class="form-group-poetic">
                            <label for="embed_color" class="form-label-poetic">Màu Embed (HEX)</label>
                            <input type="text" class="form-control-poetic" id="embed_color" name="EMBED_COLOR" value="{{ config.get('EMBED_COLOR', '#ff00af') }}" placeholder="#ff00af">
                        </div>
                         <div class="form-group-poetic">
                            <label for="refund_percentage" class="form-label-poetic">Tỷ lệ hoàn tiền khi bán role (%)</label>
                            <input type="number" step="0.01" class="form-control-poetic" id="refund_percentage" name="SELL_REFUND_PERCENTAGE" value="{{ config.get('SELL_REFUND_PERCENTAGE', 0.65) }}">
                            <div class="form-text-poetic">Ví dụ: 0.65 là hoàn lại 65%.</div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane" id="messages">
                    <h5 class="form-section-title">Embed Shop Chính</h5>
                    <div class="dynamic-row-grid">
                        <div class="form-group-poetic"><label class="form-label-poetic">Tiêu đề</label><input type="text" class="form-control-poetic" name="MESSAGES[SHOP_EMBED_TITLE]" value="{{ config.MESSAGES.get('SHOP_EMBED_TITLE', 'Shop Role') }}"></div>
                        <div class="form-group-poetic"><label class="form-label-poetic">URL Thumbnail</label><input type="url" class="form-control-poetic" name="SHOP_EMBED_THUMBNAIL_URL" value="{{ config.get('SHOP_EMBED_THUMBNAIL_URL', '') }}"></div>
                        <div class="form-group-poetic" style="grid-column: 1 / -1;"><label class="form-label-poetic">Mô tả</label><textarea class="form-control-poetic" name="MESSAGES[SHOP_EMBED_DESCRIPTION]" rows="3">{{ config.MESSAGES.get('SHOP_EMBED_DESCRIPTION', 'Chào mừng') }}</textarea></div>
                        <div class="form-group-poetic" style="grid-column: 1 / -1;"><label class="form-label-poetic">URL Ảnh Lớn</label><input type="url" class="form-control-poetic" name="SHOP_EMBED_IMAGE_URL" value="{{ config.get('SHOP_EMBED_IMAGE_URL', '') }}"></div>
                    </div>
                    <hr/>
                    <h5 class="form-section-title">Embed Thông Tin Tài Khoản</h5>
                    <div class="dynamic-row-grid">
                         <div class="form-group-poetic"><label class="form-label-poetic">Tiêu đề</label><input type="text" class="form-control-poetic" name="MESSAGES[ACCOUNT_INFO_TITLE]" value="{{ config.MESSAGES.get('ACCOUNT_INFO_TITLE', '') }}"></div>
                         <div class="form-group-poetic" style="grid-column: 1 / -1;"><label class="form-label-poetic">Mô tả</label><textarea class="form-control-poetic" name="MESSAGES[ACCOUNT_INFO_DESC]" rows="2">{{ config.MESSAGES.get('ACCOUNT_INFO_DESC', '') }}</textarea></div>
                        <div class="form-group-poetic"><label class="form-label-poetic">Tên trường "Số dư"</label><input type="text" class="form-control-poetic" name="MESSAGES[BALANCE_FIELD_NAME]" value="{{ config.MESSAGES.get('BALANCE_FIELD_NAME', 'Số Dư Hiện Tại') }}"></div>
                        <div class="form-group-poetic"><label class="form-label-poetic">Giá trị trường "Số dư"</label><input type="text" class="form-control-poetic" name="MESSAGES[BALANCE_FIELD_VALUE]" value="{{ config.MESSAGES.get('BALANCE_FIELD_VALUE', '{balance} coin') }}"><div class="form-text-poetic">Dùng <code>{balance}</code>.</div></div>
                    </div>
                    <hr/>
                    <h5 class="form-section-title">...</h5>
                </div>

                <div class="tab-pane" id="rates">
                    <h5 class="form-section-title">Tỷ lệ mặc định</h5>
                    <div class="dynamic-row-grid">
                        <div class="form-group-poetic"><label class="form-label-poetic">Tin nhắn / 1 coin</label><input type="number" class="form-control-poetic" name="CURRENCY_RATES[default][MESSAGES_PER_COIN]" value="{{ config.CURRENCY_RATES.default.get('MESSAGES_PER_COIN', '') }}"></div>
                        <div class="form-group-poetic"><label class="form-label-poetic">Reaction / 1 coin</label><input type="number" class="form-control-poetic" name="CURRENCY_RATES[default][REACTIONS_PER_COIN]" value="{{ config.CURRENCY_RATES.default.get('REACTIONS_PER_COIN', '') }}"></div>
                    </div>
                    <hr>
                    <h5 class="form-section-title">Tỷ lệ riêng cho Danh mục (Category)</h5>
                    <div id="category-rates-container">
                        {% for cat_id, rates in config.CURRENCY_RATES.categories.items() %}
                        <div class="dynamic-row rates-row">
                            <div><input type="number" class="form-control-poetic" name="category_rate_id[]" value="{{ cat_id }}" placeholder="ID Danh mục"><small class="form-text-poetic ps-2">{{ all_channels_map.get(cat_id, 'Không tìm thấy tên') }}</small></div>
                            <div><input type="number" class="form-control-poetic" name="category_rate_messages[]" value="{{ rates.MESSAGES_PER_COIN or '' }}" placeholder="Tin nhắn / coin"></div>
                            <div><input type="number" class="form-control-poetic" name="category_rate_reactions[]" value="{{ rates.REACTIONS_PER_COIN or '' }}" placeholder="Reaction / coin"></div>
                            <div class="dynamic-row-controls"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="poetic-button poetic-button-success" onclick="addCategoryRate()">Thêm</button>
                    <hr>
                    <h5 class="form-section-title">Tỷ lệ riêng cho Kênh</h5>
                    <div id="channel-rates-container">
                         {% for chan_id, rates in config.CURRENCY_RATES.channels.items() %}
                        <div class="dynamic-row rates-row">
                            <div><input type="number" class="form-control-poetic" name="channel_rate_id[]" value="{{ chan_id }}" placeholder="ID Kênh"><small class="form-text-poetic ps-2">#{{ all_channels_map.get(chan_id, 'Không tìm thấy tên') }}</small></div>
                            <div><input type="number" class="form-control-poetic" name="channel_rate_messages[]" value="{{ rates.MESSAGES_PER_COIN or '' }}" placeholder="Tin nhắn / coin"></div>
                            <div><input type="number" class="form-control-poetic" name="channel_rate_reactions[]" value="{{ rates.REACTIONS_PER_COIN or '' }}" placeholder="Reaction / coin"></div>
                            <div class="dynamic-row-controls"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="poetic-button poetic-button-success" onclick="addChannelRate()">Thêm</button>
                </div>

                <div class="tab-pane" id="customrole">
                     <h5 class="form-section-title">Cài đặt Role Tùy Chỉnh (cho Booster)</h5>
                     <div class="dynamic-row-grid">
                         <div class="form-group-poetic"><label class="form-label-poetic">Số lần boost tối thiểu</label><input type="number" class="form-control-poetic" name="CUSTOM_ROLE_CONFIG[MIN_BOOST_COUNT]" value="{{ config.CUSTOM_ROLE_CONFIG.get('MIN_BOOST_COUNT', 2) }}"></div>
                         <div class="form-group-poetic"><label class="form-label-poetic">Giá (coin)</label><input type="number" class="form-control-poetic" name="CUSTOM_ROLE_CONFIG[PRICE]" value="{{ config.CUSTOM_ROLE_CONFIG.get('PRICE', 1000) }}"></div>
                    </div>
                </div>

                <div class="tab-pane" id="qna">
                    <h5 class="form-section-title">Câu hỏi thường gặp</h5>
                    <div id="qna-container">
                        {% for item in config.get('QNA_DATA', []) %}
                        <div class="dynamic-row qna-row">
                            <div class="qna-grid-top">
                                <input type="text" class="form-control-poetic" name="qna_label[]" placeholder="Câu hỏi (menu)" value="{{ item.label }}">
                                <input type="text" class="form-control-poetic" name="qna_description[]" placeholder="Mô tả ngắn" value="{{ item.description or '' }}">
                                <input type="text" class="form-control-poetic" name="qna_emoji[]" placeholder="Emoji" value="{{ item.emoji or '' }}">
                            </div>
                            <div class="qna-grid-bottom">
                                <input type="text" class="form-control-poetic" name="qna_answer_title[]" placeholder="Tiêu đề câu trả lời" value="{{ item.answer_title or '' }}">
                                <button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button>
                            </div>
                            <textarea class="form-control-poetic" name="qna_answer_description[]" rows="3" placeholder="Nội dung câu trả lời">{{ item.answer_description or '' }}</textarea>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="poetic-button poetic-button-success" style="margin-top:1rem;" onclick="addQnA()">Thêm Q&A</button>
                </div>
            </div>
            
            <div class="form-actions">
                <a href="{{ url_for('index') }}" class="poetic-button poetic-button-secondary">Hủy</a>
                <!-- fix nut luu -->
                <button type="submit" name="submit" form="config-form" class="poetic-button poetic-button-primary">Lưu thay đổi</button>
            </div>
        </form>
    </div>
</div>

<script>
// xu ly tab nav
document.addEventListener('DOMContentLoaded', function () {
    const tabButtons = document.querySelectorAll('.config-nav-button');
    const tabPanes = document.querySelectorAll('.tab-content .tab-pane');

    tabButtons.forEach(button => {
        button.addEventListener('click', function () {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            const targetId = this.getAttribute('data-target');
            tabPanes.forEach(pane => {
                pane.classList.remove('active');
            });
            document.querySelector(targetId).classList.add('active');
        });
    });
});

function removeRow(button) { button.closest('.dynamic-row').remove(); }
function addCategoryRate() { document.getElementById('category-rates-container').insertAdjacentHTML('beforeend', `<div class="dynamic-row rates-row"><div><input type="number" class="form-control-poetic" name="category_rate_id[]" placeholder="ID Danh mục"></div><div><input type="number" class="form-control-poetic" name="category_rate_messages[]" placeholder="Tin nhắn / coin"></div><div><input type="number" class="form-control-poetic" name="category_rate_reactions[]" placeholder="Reaction / coin"></div><div class="dynamic-row-controls"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div></div>`); }
function addChannelRate() { document.getElementById('channel-rates-container').insertAdjacentHTML('beforeend', `<div class="dynamic-row rates-row"><div><input type="number" class="form-control-poetic" name="channel_rate_id[]" placeholder="ID Kênh"></div><div><input type="number" class="form-control-poetic" name="channel_rate_messages[]" placeholder="Tin nhắn / coin"></div><div><input type="number" class="form-control-poetic" name="channel_rate_reactions[]" placeholder="Reaction / coin"></div><div class="dynamic-row-controls"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div></div>`); }
function addQnA() { document.getElementById('qna-container').insertAdjacentHTML('beforeend', `<div class="dynamic-row qna-row"><div class="qna-grid-top"><input type="text" class="form-control-poetic" name="qna_label[]" placeholder="Câu hỏi (menu)"><input type="text" class="form-control-poetic" name="qna_description[]" placeholder="Mô tả ngắn"><input type="text" class="form-control-poetic" name="qna_emoji[]" placeholder="Emoji"></div><div class="qna-grid-bottom"><input type="text" class="form-control-poetic" name="qna_answer_title[]" placeholder="Tiêu đề câu trả lời"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div><textarea class="form-control-poetic" name="qna_answer_description[]" rows="3" placeholder="Nội dung câu trả lời"></textarea></div>`); }
</script>
{% endblock %}