{% extends "layout.html" %}

{% block title %}Chỉnh sửa Server {{ guild.name or guild_id }}{% endblock %}

{% block content %}
<div class="poetic-card">
    <div class="poetic-card-header poetic-card-header-with-icon">
        <img src="{{ guild.icon_url }}" alt="Server Icon" class="header-icon">
        <h2 class="poetic-header">{{ guild.name or guild_id }}</h2>
    </div>
    <div class="poetic-card-body">
        
        <form method="POST" id="config-form">

            <ul class="nav-tabs" id="configTabs">
                <li><a class="nav-link active" data-target="#general">Cài đặt chung</a></li>
                <li><a class="nav-link" data-target="#shoproles">Role Shop</a></li>
                <li><a class="nav-link" data-target="#messages">Tin nhắn & Embeds</a></li>
                <li><a class="nav-link" data-target="#rates">Tỷ lệ Coin</a></li>
                <li><a class="nav-link" data-target="#customrole">Role Tùy Chỉnh</a></li>
                <li><a class="nav-link" data-target="#qna">Q&A</a></li>
            </ul>

            <div class="tab-content" id="configTabContent">
                <div class="tab-pane active" id="general">
                    <div class="form-grid">
                        <div class="form-group-poetic">
                            <label for="shop_channel_id" class="form-label-poetic">Kênh Shop</label>
                            <select class="form-select-poetic" id="shop_channel_id" name="shop_channel_id" required>
                                <option value="">-- Chọn một kênh --</option>
                                {% for channel in text_channels %}
                                    <option value="{{ channel.id }}" {% if channel.id|string == config.shop_channel_id|string %}selected{% endif %}>
                                        #{{ channel.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text-poetic">Kênh bot sẽ gửi bảng điều khiển shop.</div>
                        </div>
                        <div class="form-group-poetic">
                            <label for="admin_log_channel_id" class="form-label-poetic">Kênh Log cho Admin</label>
                            <select class="form-select-poetic" id="admin_log_channel_id" name="ADMIN_LOG_CHANNEL_ID">
                                <option value="">-- Không gửi --</option>
                                {% for channel in text_channels %}
                                    <option value="{{ channel.id }}" {% if channel.id|string == config.get('ADMIN_LOG_CHANNEL_ID')|string %}selected{% endif %}>
                                        #{{ channel.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text-poetic">Kênh để bot gửi yêu cầu set role style cho admin.</div>
                        </div>

                        <div class="form-group-poetic full-width">
                             <label class="form-label-poetic">Role cần Ping cho yêu cầu Style</label>
                            <div class="dual-list-container">
                                <select multiple class="dual-list-box" id="available-roles">
                                    {% for role in all_roles %}
                                        {% if not role.managed and role.name != '@everyone' and (role.id|string not in config.get('CUSTOM_ROLE_PING_ROLES', [])|map('string')) %}
                                        <option value="{{ role.id }}">{{ role.name }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>

                                <div class="dual-list-controls">
                                    <button type="button" id="add-role-btn">&rsaquo;</button>
                                    <button type="button" id="remove-role-btn">&lsaquo;</button>
                                </div>
                                
                                <select multiple class="dual-list-box" name="CUSTOM_ROLE_PING_ROLES[]" id="selected-roles">
                                     {% for role in all_roles %}
                                        {% if role.id|string in config.get('CUSTOM_ROLE_PING_ROLES', [])|map('string') %}
                                        <option value="{{ role.id }}">{{ role.name }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-text-poetic">Chọn role từ cột trái và chuyển sang phải để ping khi booster yêu cầu style.</div>
                        </div>

                        <div class="form-group-poetic">
                            <label for="leaderboard_thread_id" class="form-label-poetic">ID Thread Bảng Xếp Hạng</label>
                            <input type="number" class="form-control-poetic" id="leaderboard_thread_id" name="leaderboard_thread_id" value="{{ config.leaderboard_thread_id or '' }}">
                            <div class="form-text-poetic">ID của thread BXH (thường được bot tự điền).</div>
                        </div>
                        <div class="form-group-poetic">
                            <label for="embed_color" class="form-label-poetic">Màu Embed (HEX)</label>
                            <input type="text" class="form-control-poetic" id="embed_color" name="EMBED_COLOR" value="{{ config.get('EMBED_COLOR', '#ff00af') }}" placeholder="#ff00af" data-coloris>
                        </div>
                         <div class="form-group-poetic">
                            <label for="refund_percentage" class="form-label-poetic">Tỷ lệ hoàn tiền khi bán role (%)</label>
                            <input type="number" step="0.01" class="form-control-poetic" id="refund_percentage" name="SELL_REFUND_PERCENTAGE" value="{{ config.get('SELL_REFUND_PERCENTAGE', 0.65) }}">
                            <div class="form-text-poetic">Ví dụ: 0.65 là hoàn lại 65%.</div>
                        </div>
                        <div class="form-group-poetic">
                            <label for="shop_display_style" class="form-label-poetic">Kiểu hiển thị Shop Role</label>
                            <select class="form-select-poetic" id="shop_display_style" name="SHOP_DISPLAY_STYLE">
                                <option value="select_menu" {% if config.get('SHOP_DISPLAY_STYLE', 'select_menu') == 'select_menu' %}selected{% endif %}>Menu Chọn (Mới)</option>
                                <option value="pagination" {% if config.get('SHOP_DISPLAY_STYLE') == 'pagination' %}selected{% endif %}>Phân trang (Cũ)</option>
                            </select>
                            <div class="form-text-poetic">Chọn cách bot hiển thị danh sách role cho người dùng.</div>
                        </div>
                    </div>

                    <h5 class="form-section-title">Cài đặt Hệ số nhân cho Booster</h5>
                    <div class="form-grid">
                        <div class="form-group-poetic">
                            <label class="form-label-poetic">Bật/Tắt hệ số nhân</label>
                            <select class="form-select-poetic" name="BOOSTER_MULTIPLIER_CONFIG[ENABLED]">
                                <option value="true" {% if config.BOOSTER_MULTIPLIER_CONFIG.get('ENABLED') %}selected{% endif %}>Bật</option>
                                <option value="false" {% if not config.BOOSTER_MULTIPLIER_CONFIG.get('ENABLED') %}selected{% endif %}>Tắt</option>
                            </select>
                            <div class="form-text-poetic">Bật để áp dụng hệ số nhân coin cho booster.</div>
                        </div>
                        <div class="form-group-poetic">
                            <label class="form-label-poetic">Hệ số nhân cơ bản (x)</label>
                            <input type="number" step="0.1" class="form-control-poetic" name="BOOSTER_MULTIPLIER_CONFIG[BASE_MULTIPLIER]" value="{{ config.BOOSTER_MULTIPLIER_CONFIG.get('BASE_MULTIPLIER', 2.0) }}">
                            <div class="form-text-poetic">Hệ số nhân áp dụng cho lần boost đầu tiên.</div>
                        </div>
                        <div class="form-group-poetic">
                            <label class="form-label-poetic">Mức cộng thêm cho mỗi boost (x)</label>
                            <input type="number" step="0.1" class="form-control-poetic" name="BOOSTER_MULTIPLIER_CONFIG[PER_BOOST_ADDITION]" value="{{ config.BOOSTER_MULTIPLIER_CONFIG.get('PER_BOOST_ADDITION', 0.5) }}">
                            <div class="form-text-poetic">Cộng thêm vào hệ số nhân cho mỗi lần boost sau lần đầu.</div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane" id="shoproles">
                    <h5 class="form-section-title">Quản lý tất cả Role trong Shop</h5>
                     <div class="form-text-poetic" style="margin-bottom: 1.5rem;">Khu vực này hiển thị tất cả role đang có trong shop, bao gồm cả role do Admin tạo và do thành viên tạo.</div>
                    <div id="shop-roles-container">
                        {% for role in shop_roles %}
                        <div class="dynamic-row">
                            <div class="dynamic-row-content" style="grid-template-columns: 2fr 1fr 1fr;">
                                <div class="form-group-poetic" style="margin:0;">
                                    <label class="form-label-poetic">Tên Role</label>
                                    <input type="hidden" name="shop_role_id[]" value="{{ role.id }}">
                                    <input type="hidden" name="shop_role_creator_id[]" value="{{ role.creator_id or '' }}">
                                    <input type="text" class="form-control-poetic" name="shop_role_name[]" value="{{ role.name }}" placeholder="Ví dụ: VIP Member">
                                </div>
                                <div class="form-group-poetic" style="margin:0;">
                                    <label class="form-label-poetic">Giá (coin)</label>
                                    <input type="number" class="form-control-poetic" name="shop_role_price[]" value="{{ role.price }}" placeholder="Nhập giá">
                                </div>
                                <div class="form-group-poetic" style="margin:0;">
                                    <label class="form-label-poetic">Màu (HEX)</label>
                                    <input type="text" class="form-control-poetic" name="shop_role_color[]" value="{{ role.color }}" placeholder="#ffaaaa" data-coloris>
                                </div>
                                {% if role.creator_id %}
                                <div class="form-text-poetic full-width" style="margin-top:0.5rem; color: var(--info-color);">
                                    Tạo bởi: {{ user_details[role.creator_id|string].name or 'Không rõ' }} (ID: {{ role.creator_id }})
                                </div>
                                {% endif %}
                            </div>
                            <div class="dynamic-row-actions"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="poetic-button poetic-button-success" style="margin-top: 1rem;" onclick="addShopRole()">Thêm Role (Admin)</button>
                </div>

                <div class="tab-pane" id="messages">
                    <h5 class="form-section-title">Embed Shop Chính</h5>
                     <div class="embed-preview-container" id="shop-embed-preview-container">
                        <label class="form-label-poetic" style="text-align: center; margin-bottom: 1rem;">Xem trước Embed</label>
                        <div class="discord-embed-preview" id="discord-shop-embed-preview">
                           <div class="embed-content-wrapper">
                                <div class="embed-main">
                                    <div class="embed-title" id="preview-shop-title"></div>
                                    <div class="embed-description" id="preview-shop-description"></div>
                                </div>
                                <div class="embed-image">
                                    <img src="" alt="" id="preview-shop-image" style="display:none;">
                                </div>
                                <div class="embed-footer" id="preview-shop-footer"></div>
                            </div>
                            <div class="embed-thumbnail">
                                <img src="" alt="" id="preview-shop-thumbnail" style="display:none;">
                            </div>
                        </div>
                    </div>
                    <div class="form-grid" style="margin-top: 2rem;">
                        <div class="form-group-poetic"><label class="form-label-poetic">Tiêu đề</label><input type="text" class="form-control-poetic" name="MESSAGES[SHOP_EMBED_TITLE]" value="{{ config.MESSAGES.get('SHOP_EMBED_TITLE', 'Shop Role') }}"></div>
                        <div class="form-group-poetic"><label class="form-label-poetic">URL Thumbnail</label><input type="url" class="form-control-poetic" name="SHOP_EMBED_THUMBNAIL_URL" value="{{ config.get('SHOP_EMBED_THUMBNAIL_URL', '') }}"></div>
                        <div class="form-group-poetic full-width">
                            <div class="textarea-wrapper">
                                <label class="form-label-poetic">Mô tả</label>
                                <button type="button" class="expand-toggle-btn" title="Mở rộng/Thu gọn">+</button>
                                <textarea class="form-control-poetic" name="MESSAGES[SHOP_EMBED_DESCRIPTION]" rows="3">{{ config.MESSAGES.get('SHOP_EMBED_DESCRIPTION', 'Chào mừng') }}</textarea>
                            </div>
                        </div>
                        <div class="form-group-poetic full-width"><label class="form-label-poetic">URL Ảnh Lớn</label><input type="url" class="form-control-poetic" name="SHOP_EMBED_IMAGE_URL" value="{{ config.get('SHOP_EMBED_IMAGE_URL', '') }}"></div>
                        <div class="form-group-poetic full-width"><label class="form-label-poetic">Footer</label><input type="text" class="form-control-poetic" name="FOOTER_MESSAGES[SHOP_PANEL]" value="{{ config.FOOTER_MESSAGES.get('SHOP_PANEL', '') }}"></div>
                    </div>
                    <hr/>
                    <h5 class="form-section-title">Embed Thông Tin Tài Khoản</h5>
                    <div class="embed-preview-container" id="account-embed-preview-container">
                        <label class="form-label-poetic" style="text-align: center; margin-bottom: 1rem;">Xem trước Embed</label>
                        <div class="discord-embed-preview" id="discord-account-embed-preview">
                           <div class="embed-content-wrapper">
                                <div class="embed-main">
                                    <div class="embed-title" id="preview-account-title"></div>
                                    <div class="embed-description" id="preview-account-description"></div>
                                    <div class="embed-field-container">
                                        <div class="embed-field-name" id="preview-account-field-name"></div>
                                        <div class="embed-field-value" id="preview-account-field-value"></div>
                                    </div>
                                </div>
                                <div class="embed-footer" id="preview-account-footer"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-grid" style="margin-top: 2rem;">
                         <div class="form-group-poetic"><label class="form-label-poetic">Tiêu đề</label><input type="text" class="form-control-poetic" name="MESSAGES[ACCOUNT_INFO_TITLE]" value="{{ config.MESSAGES.get('ACCOUNT_INFO_TITLE', '') }}"></div>
                         <div class="form-group-poetic full-width">
                             <div class="textarea-wrapper">
                                 <label class="form-label-poetic">Mô tả</label>
                                 <button type="button" class="expand-toggle-btn" title="Mở rộng/Thu gọn">+</button>
                                 <textarea class="form-control-poetic" name="MESSAGES[ACCOUNT_INFO_DESC]" rows="2">{{ config.MESSAGES.get('ACCOUNT_INFO_DESC', '') }}</textarea>
                             </div>
                         </div>
                        <div class="form-group-poetic"><label class="form-label-poetic">Tên trường "Số dư"</label><input type="text" class="form-control-poetic" name="MESSAGES[BALANCE_FIELD_NAME]" value="{{ config.MESSAGES.get('BALANCE_FIELD_NAME', 'Số Dư Hiện Tại') }}"></div>
                        <div class="form-group-poetic"><label class="form-label-poetic">Giá trị trường "Số dư"</label><input type="text" class="form-control-poetic" name="MESSAGES[BALANCE_FIELD_VALUE]" value="{{ config.MESSAGES.get('BALANCE_FIELD_VALUE', '{balance} coin') }}"><div class="form-text-poetic">Dùng <code>{balance}</code>.</div></div>
                        <div class="form-group-poetic full-width"><label class="form-label-poetic">Footer</label><input type="text" class="form-control-poetic" name="FOOTER_MESSAGES[ACCOUNT_INFO]" value="{{ config.FOOTER_MESSAGES.get('ACCOUNT_INFO', '') }}"></div>
                    </div>
                    <hr/>
                    <h5 class="form-section-title">Embed Tỷ Lệ Đào Coin</h5>
                    <div class="embed-preview-container" id="rates-embed-preview-container">
                        <label class="form-label-poetic" style="text-align: center; margin-bottom: 1rem;">Xem trước Embed</label>
                        <div class="discord-embed-preview" id="discord-rates-embed-preview">
                           <div class="embed-content-wrapper">
                                <div class="embed-main">
                                    <div class="embed-title" id="preview-rates-title"></div>
                                    <div class="embed-description" id="preview-rates-description"></div>
                                </div>
                                <div class="embed-image">
                                    <img src="" alt="" id="preview-rates-image" style="display:none;">
                                </div>
                                <div class="embed-footer" id="preview-rates-footer"></div>
                            </div>
                        </div>
                    </div>
                     <div class="form-grid" style="margin-top: 2rem;">
                        <div class="form-group-poetic"><label class="form-label-poetic">Tiêu đề</label><input type="text" class="form-control-poetic" name="MESSAGES[EARNING_RATES_TITLE]" value="{{ config.MESSAGES.get('EARNING_RATES_TITLE', 'Tỷ lệ kiếm coin') }}"></div>
                        <div class="form-group-poetic"><label class="form-label-poetic">URL Ảnh</label><input type="url" class="form-control-poetic" name="EARNING_RATES_IMAGE_URL" value="{{ config.get('EARNING_RATES_IMAGE_URL', '') }}"></div>
                        <div class="form-group-poetic full-width">
                            <div class="textarea-wrapper">
                                <label class="form-label-poetic">Mô tả chính</label>
                                <button type="button" class="expand-toggle-btn" title="Mở rộng/Thu gọn">+</button>
                                <textarea class="form-control-poetic" name="MESSAGES[EARNING_RATES_DESC]" rows="3">{{ config.MESSAGES.get('EARNING_RATES_DESC', '') }}</textarea>
                                <div class="form-text-poetic">Dùng <code>\n</code> để xuống dòng.</div>
                            </div>
                        </div>
                        <div class="form-group-poetic full-width">
                            <div class="textarea-wrapper">
                                <label class="form-label-poetic">Thông tin cho Booster</label>
                                <button type="button" class="expand-toggle-btn" title="Mở rộng/Thu gọn">+</button>
                                <textarea class="form-control-poetic" name="MESSAGES[BOOSTER_MULTIPLIER_INFO]" rows="2">{{ config.MESSAGES.get('BOOSTER_MULTIPLIER_INFO', '') }}</textarea>
                            </div>
                        </div>
                        <div class="form-group-poetic full-width"><label class="form-label-poetic">Footer</label><input type="text" class="form-control-poetic" name="FOOTER_MESSAGES[EARNING_RATES]" value="{{ config.FOOTER_MESSAGES.get('EARNING_RATES', '') }}"></div>
                    </div>
                    <hr/>
                    <h5 class="form-section-title">Tin Nhắn Role Tùy Chỉnh (Booster)</h5>
                    <div class="form-grid">
                        <div class="form-group-poetic full-width"><label class="form-label-poetic">Khi không đủ boost</label><input type="text" class="form-control-poetic" name="MESSAGES[CUSTOM_ROLE_NO_BOOSTS]" value="{{ config.MESSAGES.get('CUSTOM_ROLE_NO_BOOSTS', 'Bạn cần có ít nhất {min_boosts} boost để dùng tính năng này.') }}"><div class="form-text-poetic">Dùng <code>{min_boosts}</code> và <code>{boost_count}</code>.</div></div>
                        <div class="form-group-poetic full-width"><label class="form-label-poetic">Khi đã sở hữu role</label><input type="text" class="form-control-poetic" name="MESSAGES[CUSTOM_ROLE_ALREADY_OWNED]" value="{{ config.MESSAGES.get('CUSTOM_ROLE_ALREADY_OWNED', 'Bạn đã có một role tùy chỉnh rồi. Hãy dùng nút "Quản lý Role" để chỉnh sửa.') }}"></div>
                        <div class="form-group-poetic full-width"><label class="form-label-poetic">Khi chưa sở hữu role (để quản lý)</label><input type="text" class="form-control-poetic" name="MESSAGES[CUSTOM_ROLE_NOT_OWNED]" value="{{ config.MESSAGES.get('CUSTOM_ROLE_NOT_OWNED', 'Bạn chưa tạo role tùy chỉnh nào cả.') }}"></div>
                        <div class="form-group-poetic full-width"><label class="form-label-poetic">Khi không đủ coin</label><input type="text" class="form-control-poetic" name="MESSAGES[CUSTOM_ROLE_NO_COIN]" value="{{ config.MESSAGES.get('CUSTOM_ROLE_NO_COIN', 'Bạn không đủ coin! Cần {price} coin nhưng bạn chỉ có {balance}.') }}"><div class="form-text-poetic">Dùng <code>{price}</code> và <code>{balance}</code>.</div></div>
                        <div class="form-group-poetic full-width">
                            <div class="textarea-wrapper">
                                <label class="form-label-poetic">Lời nhắc khi quản lý role</label>
                                <button type="button" class="expand-toggle-btn" title="Mở rộng/Thu gọn">+</button>
                                <textarea class="form-control-poetic" name="MESSAGES[CUSTOM_ROLE_MANAGE_PROMPT]" rows="2">{{ config.MESSAGES.get('CUSTOM_ROLE_MANAGE_PROMPT', 'Đây là role tùy chỉnh của bạn. Sử dụng menu bên dưới để Sửa hoặc Xóa.') }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane" id="rates">
                    <h5 class="form-section-title">Tỷ lệ mặc định</h5>
                    <div class="form-grid">
                        <div class="form-group-poetic"><label class="form-label-poetic">Tin nhắn / 1 coin</label><input type="number" class="form-control-poetic" name="CURRENCY_RATES[default][MESSAGES_PER_COIN]" value="{{ config.CURRENCY_RATES.default.get('MESSAGES_PER_COIN', '') }}"></div>
                        <div class="form-group-poetic"><label class="form-label-poetic">Reaction / 1 coin</label><input type="number" class="form-control-poetic" name="CURRENCY_RATES[default][REACTIONS_PER_COIN]" value="{{ config.CURRENCY_RATES.default.get('REACTIONS_PER_COIN', '') }}"></div>
                    </div>
                    <hr>
                    <h5 class="form-section-title">Tỷ lệ riêng cho Danh mục (Category)</h5>
                    <div id="category-rates-container">
                        {% for cat_id, rates in config.CURRENCY_RATES.categories.items() %}
                        <div class="dynamic-row rates-row">
                            <div class="dynamic-row-content">
                                <div class="form-group-poetic" style="margin:0;">
                                    <label class="form-label-poetic">Danh mục</label>
                                    <select class="form-select-poetic" name="category_rate_id[]">
                                        <option value="">-- Chọn danh mục --</option>
                                        {% for category in category_channels %}
                                        <option value="{{ category.id }}" {% if category.id|string == cat_id %}selected{% endif %}>{{ category.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Tin nhắn/coin</label><input type="number" class="form-control-poetic" name="category_rate_messages[]" value="{{ rates.MESSAGES_PER_COIN or '' }}"></div>
                                <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Reaction/coin</label><input type="number" class="form-control-poetic" name="category_rate_reactions[]" value="{{ rates.REACTIONS_PER_COIN or '' }}"></div>
                            </div>
                            <div class="dynamic-row-actions"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="poetic-button poetic-button-success" style="margin-top: 1rem;" onclick="addCategoryRate()">Thêm</button>
                    <hr>
                    <h5 class="form-section-title">Tỷ lệ riêng cho Kênh</h5>
                    <div id="channel-rates-container">
                         {% for chan_id, rates in config.CURRENCY_RATES.channels.items() %}
                        <div class="dynamic-row rates-row">
                             <div class="dynamic-row-content">
                                <div class="form-group-poetic" style="margin:0;">
                                    <label class="form-label-poetic">Kênh</label>
                                    <select class="form-select-poetic" name="channel_rate_id[]">
                                        <option value="">-- Chọn kênh --</option>
                                        {% for channel in rateable_channels %}
                                        <option value="{{ channel.id }}" {% if channel.id|string == chan_id %}selected{% endif %}>#{{ channel.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Tin nhắn/coin</label><input type="number" class="form-control-poetic" name="channel_rate_messages[]" value="{{ rates.MESSAGES_PER_COIN or '' }}"></div>
                                <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Reaction/coin</label><input type="number" class="form-control-poetic" name="channel_rate_reactions[]" value="{{ rates.REACTIONS_PER_COIN or '' }}"></div>
                            </div>
                            <div class="dynamic-row-actions"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="poetic-button poetic-button-success" style="margin-top: 1rem;" onclick="addChannelRate()">Thêm</button>
                </div>

                <div class="tab-pane" id="customrole">
                     <h5 class="form-section-title">Cài đặt Role Tùy Chỉnh (cho Booster)</h5>
                     <div class="form-grid">
                         <div class="form-group-poetic"><label class="form-label-poetic">Số lần boost tối thiểu</label><input type="number" class="form-control-poetic" name="CUSTOM_ROLE_CONFIG[MIN_BOOST_COUNT]" value="{{ config.CUSTOM_ROLE_CONFIG.get('MIN_BOOST_COUNT', 2) }}"></div>
                         <div class="form-group-poetic"><label class="form-label-poetic">Giá tạo role (coin)</label><input type="number" class="form-control-poetic" name="CUSTOM_ROLE_CONFIG[PRICE]" value="{{ config.CUSTOM_ROLE_CONFIG.get('PRICE', 1000) }}"></div>
                    </div>
                    <hr>
                    <h5 class="form-section-title">Cài đặt Tạo Role (Thành viên thường)</h5>
                    <div class="form-grid">
                        <div class="form-group-poetic">
                            <label class="form-label-poetic">Bật/Tắt tính năng</label>
                            <select class="form-select-poetic" name="REGULAR_USER_ROLE_CREATION[ENABLED]">
                                <option value="true" {% if config.REGULAR_USER_ROLE_CREATION.get('ENABLED') %}selected{% endif %}>Bật</option>
                                <option value="false" {% if not config.REGULAR_USER_ROLE_CREATION.get('ENABLED') %}selected{% endif %}>Tắt</option>
                            </select>
                        </div>
                        <div class="form-group-poetic">
                            <label class="form-label-poetic">Giá tạo role TỐI THIỂU (coin)</label>
                            <input type="number" class="form-control-poetic" name="REGULAR_USER_ROLE_CREATION[CREATION_PRICE]" value="{{ config.REGULAR_USER_ROLE_CREATION.get('CREATION_PRICE', 2000) }}">
                        </div>
                         <div class="form-group-poetic">
                            <label class="form-label-poetic">Hệ số giá bán trong shop</label>
                            <input type="number" step="0.1" class="form-control-poetic" name="REGULAR_USER_ROLE_CREATION[SHOP_PRICE_MULTIPLIER]" value="{{ config.REGULAR_USER_ROLE_CREATION.get('SHOP_PRICE_MULTIPLIER', 1.2) }}">
                            <div class="form-text-poetic">Giá bán = giá tạo x hệ số. VD: 1.2 là cao hơn 20%.</div>
                        </div>
                    </div>
                    <hr>
                    <h5 class="form-section-title">Cài đặt Shop cho Role Tùy Chỉnh</h5>
                     <div class="form-grid">
                        <div class="form-group-poetic">
                            <label class="form-label-poetic">Giá MUA mặc định (coin)</label>
                            <input type="number" class="form-control-poetic" name="CUSTOM_ROLE_CONFIG[DEFAULT_PURCHASE_PRICE]" value="{{ config.CUSTOM_ROLE_CONFIG.get('DEFAULT_PURCHASE_PRICE', 500) }}">
                            <div class="form-text-poetic">Giá bán trong shop cho một role sau khi nó được người khác tạo ra.</div>
                        </div>
                     </div>
                </div>

                <div class="tab-pane" id="qna">
                    <h5 class="form-section-title">Câu hỏi thường gặp</h5>
                    <div id="qna-container">
                        {% for item in config.get('QNA_DATA', []) %}
                        <div class="dynamic-row qna-row">
                            <div class="qna-row-header">
                                <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Câu hỏi (menu)</label><input type="text" class="form-control-poetic" name="qna_label[]" value="{{ item.label }}"></div>
                                <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Mô tả ngắn</label><input type="text" class="form-control-poetic" name="qna_description[]" value="{{ item.description or '' }}"></div>
                                <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Emoji</label><input type="text" class="form-control-poetic" name="qna_emoji[]" value="{{ item.emoji or '' }}"></div>
                            </div>
                            <div class="qna-row-body">
                                <div class="form-group-poetic" style="margin:0; flex-grow:1;"><label class="form-label-poetic">Tiêu đề trả lời</label><input type="text" class="form-control-poetic" name="qna_answer_title[]" value="{{ item.answer_title or '' }}"></div>
                                <div class="dynamic-row-actions"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div>
                            </div>
                            <div class="form-group-poetic" style="margin:0; width: 100%;">
                                <div class="textarea-wrapper">
                                    <label class="form-label-poetic">Nội dung trả lời</label>
                                    <button type="button" class="expand-toggle-btn" title="Mở rộng/Thu gọn">+</button>
                                    <textarea class="form-control-poetic" name="qna_answer_description[]" rows="3">{{ item.answer_description or '' }}</textarea>
                                </div>
                            </div>
                            <div class="embed-preview-container qna-preview-container">
                                <div class="discord-embed-preview">
                                    <div class="embed-content-wrapper">
                                        <div class="embed-main">
                                            <div class="embed-title preview-qna-title"></div>
                                            <div class="embed-description preview-qna-description"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="poetic-button poetic-button-success" style="margin-top:1rem;" onclick="addQnA()">Thêm Q&A</button>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" name="submit" class="poetic-button poetic-button-primary">Lưu thay đổi</button>
            </div>
        </form>
    </div>
</div>

<!-- templates js -->
<template id="shop-role-template">
    <div class="dynamic-row">
        <div class="dynamic-row-content" style="grid-template-columns: 2fr 1fr 1fr;">
            <div class="form-group-poetic" style="margin:0;">
                <label class="form-label-poetic">Tên Role</label>
                <input type="hidden" name="shop_role_id[]" value="">
                <input type="hidden" name="shop_role_creator_id[]" value="">
                <input type="text" class="form-control-poetic" name="shop_role_name[]" placeholder="Ví dụ: VIP Member">
            </div>
            <div class="form-group-poetic" style="margin:0;">
                <label class="form-label-poetic">Giá (coin)</label>
                <input type="number" class="form-control-poetic" name="shop_role_price[]" placeholder="Nhập giá">
            </div>
            <div class="form-group-poetic" style="margin:0;">
                <label class="form-label-poetic">Màu (HEX)</label>
                <input type="text" class="form-control-poetic" name="shop_role_color[]" value="#99aab5" placeholder="#ffaaaa" data-coloris>
            </div>
        </div>
        <div class="dynamic-row-actions"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div>
    </div>
</template>

<template id="category-rate-template">
    <div class="dynamic-row rates-row">
        <div class="dynamic-row-content">
            <div class="form-group-poetic" style="margin:0;">
                <label class="form-label-poetic">Danh mục</label>
                <select class="form-select-poetic" name="category_rate_id[]">
                    <option value="">-- Chọn danh mục --</option>
                    {% for category in category_channels %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Tin nhắn/coin</label><input type="number" class="form-control-poetic" name="category_rate_messages[]"></div>
            <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Reaction/coin</label><input type="number" class="form-control-poetic" name="category_rate_reactions[]"></div>
        </div>
        <div class="dynamic-row-actions"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div>
    </div>
</template>

<template id="channel-rate-template">
    <div class="dynamic-row rates-row">
        <div class="dynamic-row-content">
            <div class="form-group-poetic" style="margin:0;">
                <label class="form-label-poetic">Kênh</label>
                <select class="form-select-poetic" name="channel_rate_id[]">
                    <option value="">-- Chọn kênh --</option>
                    {% for channel in rateable_channels %}
                    <option value="{{ channel.id }}">#{{ channel.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Tin nhắn/coin</label><input type="number" class="form-control-poetic" name="channel_rate_messages[]"></div>
            <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Reaction/coin</label><input type="number" class="form-control-poetic" name="channel_rate_reactions[]"></div>
        </div>
        <div class="dynamic-row-actions"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div>
    </div>
</template>

<template id="qna-template">
    <div class="dynamic-row qna-row">
        <div class="qna-row-header">
            <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Câu hỏi (menu)</label><input type="text" class="form-control-poetic" name="qna_label[]"></div>
            <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Mô tả ngắn</label><input type="text" class="form-control-poetic" name="qna_description[]"></div>
            <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Emoji</label><input type="text" class="form-control-poetic" name="qna_emoji[]"></div>
        </div>
        <div class="qna-row-body">
            <div class="form-group-poetic" style="margin:0; flex-grow:1;"><label class="form-label-poetic">Tiêu đề trả lời</label><input type="text" class="form-control-poetic" name="qna_answer_title[]"></div>
            <div class="dynamic-row-actions"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div>
        </div>
        <div class="form-group-poetic" style="margin:0; width: 100%;">
            <div class="textarea-wrapper">
                <label class="form-label-poetic">Nội dung trả lời</label>
                <button type="button" class="expand-toggle-btn" title="Mở rộng/Thu gọn">+</button>
                <textarea class="form-control-poetic" name="qna_answer_description[]" rows="3"></textarea>
            </div>
        </div>
        <div class="embed-preview-container qna-preview-container">
            <div class="discord-embed-preview">
                <div class="embed-content-wrapper">
                    <div class="embed-main">
                        <div class="embed-title preview-qna-title"></div>
                        <div class="embed-description preview-qna-description"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

{% endblock %}