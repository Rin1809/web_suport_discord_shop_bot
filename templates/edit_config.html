{% extends "layout.html" %}

{% block title %}Chỉnh sửa Server {{ guild.name or guild_id }}{% endblock %}

{% block content %}
<div class="poetic-card">
    <div class="poetic-card-header">
        <h2 class="poetic-header">Chỉnh sửa: {{ guild.name or guild_id }}</h2>
    </div>
    <div class="poetic-card-body">
        <form method="POST" id="config-form">
            <div class="config-nav" id="configTabNav">
                <button class="config-nav-button active" data-target="#general" type="button">Cài đặt chung</button>
                <button class="config-nav-button" data-target="#messages" type="button">Tin nhắn & Embeds</button>
                <button class="config-nav-button" data-target="#rates" type="button">Tỷ lệ Coin</button>
                <button class="config-nav-button" data-target="#customrole" type="button">Role Tùy Chỉnh</button>
                <button class="config-nav-button" data-target="#qna" type="button">Q&A</button>
            </div>

            <div class="tab-content" id="configTabContent">
                <div class="tab-pane active" id="general">
                    <div class="form-grid">
                        <div class="form-group-poetic">
                            <label for="shop_channel_id" class="form-label-poetic">Kênh Shop</label>
                            <select class="form-select-poetic" id="shop_channel_id" name="shop_channel_id" required>
                                <option value="">-- Chọn một kênh --</option>
                                {% for channel in text_channels %}
                                    <option value="{{ channel.id }}" {% if channel.id|string == config.shop_channel_id|string %}selected{% endif %}>
                                        #{{ channel.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text-poetic">Kênh bot sẽ gửi bảng điều khiển shop.</div>
                        </div>
                        <div class="form-group-poetic">
                            <label for="leaderboard_thread_id" class="form-label-poetic">ID Thread Bảng Xếp Hạng</label>
                            <input type="number" class="form-control-poetic" id="leaderboard_thread_id" name="leaderboard_thread_id" value="{{ config.leaderboard_thread_id or '' }}">
                            <div class="form-text-poetic">ID của thread BXH (thường được bot tự điền).</div>
                        </div>
                        <div class="form-group-poetic">
                            <label for="embed_color" class="form-label-poetic">Màu Embed (HEX)</label>
                            <input type="text" class="form-control-poetic" id="embed_color" name="EMBED_COLOR" value="{{ config.get('EMBED_COLOR', '#ff00af') }}" placeholder="#ff00af">
                        </div>
                         <div class="form-group-poetic">
                            <label for="refund_percentage" class="form-label-poetic">Tỷ lệ hoàn tiền khi bán role (%)</label>
                            <input type="number" step="0.01" class="form-control-poetic" id="refund_percentage" name="SELL_REFUND_PERCENTAGE" value="{{ config.get('SELL_REFUND_PERCENTAGE', 0.65) }}">
                            <div class="form-text-poetic">Ví dụ: 0.65 là hoàn lại 65%.</div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane" id="messages">
                    <h5 class="form-section-title">Embed Shop Chính</h5>
                    <div class="form-grid">
                        <div class="form-group-poetic"><label class="form-label-poetic">Tiêu đề</label><input type="text" class="form-control-poetic" name="MESSAGES[SHOP_EMBED_TITLE]" value="{{ config.MESSAGES.get('SHOP_EMBED_TITLE', 'Shop Role') }}"></div>
                        <div class="form-group-poetic"><label class="form-label-poetic">URL Thumbnail</label><input type="url" class="form-control-poetic" name="SHOP_EMBED_THUMBNAIL_URL" value="{{ config.get('SHOP_EMBED_THUMBNAIL_URL', '') }}"></div>
                        <div class="form-group-poetic full-width"><label class="form-label-poetic">Mô tả</label><textarea class="form-control-poetic" name="MESSAGES[SHOP_EMBED_DESCRIPTION]" rows="3">{{ config.MESSAGES.get('SHOP_EMBED_DESCRIPTION', 'Chào mừng') }}</textarea></div>
                        <div class="form-group-poetic full-width"><label class="form-label-poetic">URL Ảnh Lớn</label><input type="url" class="form-control-poetic" name="SHOP_EMBED_IMAGE_URL" value="{{ config.get('SHOP_EMBED_IMAGE_URL', '') }}"></div>
                    </div>
                    <hr/>
                    <h5 class="form-section-title">Embed Thông Tin Tài Khoản</h5>
                    <div class="form-grid">
                         <div class="form-group-poetic"><label class="form-label-poetic">Tiêu đề</label><input type="text" class="form-control-poetic" name="MESSAGES[ACCOUNT_INFO_TITLE]" value="{{ config.MESSAGES.get('ACCOUNT_INFO_TITLE', '') }}"></div>
                         <div class="form-group-poetic full-width"><label class="form-label-poetic">Mô tả</label><textarea class="form-control-poetic" name="MESSAGES[ACCOUNT_INFO_DESC]" rows="2">{{ config.MESSAGES.get('ACCOUNT_INFO_DESC', '') }}</textarea></div>
                        <div class="form-group-poetic"><label class="form-label-poetic">Tên trường "Số dư"</label><input type="text" class="form-control-poetic" name="MESSAGES[BALANCE_FIELD_NAME]" value="{{ config.MESSAGES.get('BALANCE_FIELD_NAME', 'Số Dư Hiện Tại') }}"></div>
                        <div class="form-group-poetic"><label class="form-label-poetic">Giá trị trường "Số dư"</label><input type="text" class="form-control-poetic" name="MESSAGES[BALANCE_FIELD_VALUE]" value="{{ config.MESSAGES.get('BALANCE_FIELD_VALUE', '{balance} coin') }}"><div class="form-text-poetic">Dùng <code>{balance}</code>.</div></div>
                    </div>
                    <hr/>
                    <h5 class="form-section-title">Embed Tỷ Lệ Đào Coin</h5>
                     <div class="form-grid">
                        <div class="form-group-poetic"><label class="form-label-poetic">Tiêu đề</label><input type="text" class="form-control-poetic" name="MESSAGES[EARNING_RATES_TITLE]" value="{{ config.MESSAGES.get('EARNING_RATES_TITLE', 'Tỷ lệ kiếm coin') }}"></div>
                        <div class="form-group-poetic"><label class="form-label-poetic">URL Ảnh</label><input type="url" class="form-control-poetic" name="EARNING_RATES_IMAGE_URL" value="{{ config.get('EARNING_RATES_IMAGE_URL', '') }}"></div>
                        <div class="form-group-poetic full-width"><label class="form-label-poetic">Mô tả chính</label><textarea class="form-control-poetic" name="MESSAGES[EARNING_RATES_DESC]" rows="3">{{ config.MESSAGES.get('EARNING_RATES_DESC', '') }}</textarea><div class="form-text-poetic">Dùng <code>\n</code> để xuống dòng.</div></div>
                        <div class="form-group-poetic full-width"><label class="form-label-poetic">Thông tin cho Booster</label><textarea class="form-control-poetic" name="MESSAGES[BOOSTER_MULTIPLIER_INFO]" rows="2">{{ config.MESSAGES.get('BOOSTER_MULTIPLIER_INFO', '') }}</textarea></div>
                        <div class="form-group-poetic full-width"><label class="form-label-poetic">Footer</label><input type="text" class="form-control-poetic" name="FOOTER_MESSAGES[EARNING_RATES]" value="{{ config.FOOTER_MESSAGES.get('EARNING_RATES', '') }}"></div>
                    </div>
                    <hr/>
                    <h5 class="form-section-title">Tin Nhắn Role Tùy Chỉnh (Booster)</h5>
                    <div class="form-grid">
                        <div class="form-group-poetic full-width"><label class="form-label-poetic">Khi không đủ boost</label><input type="text" class="form-control-poetic" name="MESSAGES[CUSTOM_ROLE_NO_BOOSTS]" value="{{ config.MESSAGES.get('CUSTOM_ROLE_NO_BOOSTS', 'Bạn cần có ít nhất {min_boosts} boost để dùng tính năng này.') }}"><div class="form-text-poetic">Dùng <code>{min_boosts}</code> và <code>{boost_count}</code>.</div></div>
                        <div class="form-group-poetic full-width"><label class="form-label-poetic">Khi đã sở hữu role</label><input type="text" class="form-control-poetic" name="MESSAGES[CUSTOM_ROLE_ALREADY_OWNED]" value="{{ config.MESSAGES.get('CUSTOM_ROLE_ALREADY_OWNED', 'Bạn đã có một role tùy chỉnh rồi. Hãy dùng nút "Quản lý Role" để chỉnh sửa.') }}"></div>
                        <div class="form-group-poetic full-width"><label class="form-label-poetic">Khi chưa sở hữu role (để quản lý)</label><input type="text" class="form-control-poetic" name="MESSAGES[CUSTOM_ROLE_NOT_OWNED]" value="{{ config.MESSAGES.get('CUSTOM_ROLE_NOT_OWNED', 'Bạn chưa tạo role tùy chỉnh nào cả.') }}"></div>
                        <div class="form-group-poetic full-width"><label class="form-label-poetic">Khi không đủ coin</label><input type="text" class="form-control-poetic" name="MESSAGES[CUSTOM_ROLE_NO_COIN]" value="{{ config.MESSAGES.get('CUSTOM_ROLE_NO_COIN', 'Bạn không đủ coin! Cần {price} coin nhưng bạn chỉ có {balance}.') }}"><div class="form-text-poetic">Dùng <code>{price}</code> và <code>{balance}</code>.</div></div>
                        <div class="form-group-poetic full-width"><label class="form-label-poetic">Lời nhắc khi quản lý role</label><textarea class="form-control-poetic" name="MESSAGES[CUSTOM_ROLE_MANAGE_PROMPT]" rows="2">{{ config.MESSAGES.get('CUSTOM_ROLE_MANAGE_PROMPT', 'Đây là role tùy chỉnh của bạn. Sử dụng menu bên dưới để Sửa hoặc Xóa.') }}</textarea></div>
                    </div>
                </div>

                <div class="tab-pane" id="rates">
                    <h5 class="form-section-title">Tỷ lệ mặc định</h5>
                    <div class="form-grid">
                        <div class="form-group-poetic"><label class="form-label-poetic">Tin nhắn / 1 coin</label><input type="number" class="form-control-poetic" name="CURRENCY_RATES[default][MESSAGES_PER_COIN]" value="{{ config.CURRENCY_RATES.default.get('MESSAGES_PER_COIN', '') }}"></div>
                        <div class="form-group-poetic"><label class="form-label-poetic">Reaction / 1 coin</label><input type="number" class="form-control-poetic" name="CURRENCY_RATES[default][REACTIONS_PER_COIN]" value="{{ config.CURRENCY_RATES.default.get('REACTIONS_PER_COIN', '') }}"></div>
                    </div>
                    <hr>
                    <h5 class="form-section-title">Tỷ lệ riêng cho Danh mục (Category)</h5>
                    <div id="category-rates-container">
                        {% for cat_id, rates in config.CURRENCY_RATES.categories.items() %}
                        <div class="dynamic-row rates-row">
                            <div class="dynamic-row-content">
                                <div class="form-group-poetic" style="margin:0;">
                                    <label class="form-label-poetic">Danh mục</label>
                                    <select class="form-select-poetic" name="category_rate_id[]">
                                        <option value="">-- Chọn danh mục --</option>
                                        {% for category in category_channels %}
                                        <option value="{{ category.id }}" {% if category.id|string == cat_id %}selected{% endif %}>{{ category.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Tin nhắn/coin</label><input type="number" class="form-control-poetic" name="category_rate_messages[]" value="{{ rates.MESSAGES_PER_COIN or '' }}"></div>
                                <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Reaction/coin</label><input type="number" class="form-control-poetic" name="category_rate_reactions[]" value="{{ rates.REACTIONS_PER_COIN or '' }}"></div>
                            </div>
                            <div class="dynamic-row-actions"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="poetic-button poetic-button-success" style="margin-top: 1rem;" onclick="addCategoryRate()">Thêm</button>
                    <hr>
                    <h5 class="form-section-title">Tỷ lệ riêng cho Kênh</h5>
                    <div id="channel-rates-container">
                         {% for chan_id, rates in config.CURRENCY_RATES.channels.items() %}
                        <div class="dynamic-row rates-row">
                             <div class="dynamic-row-content">
                                <div class="form-group-poetic" style="margin:0;">
                                    <label class="form-label-poetic">Kênh</label>
                                    <select class="form-select-poetic" name="channel_rate_id[]">
                                        <option value="">-- Chọn kênh --</option>
                                        {% for channel in rateable_channels %}
                                        <option value="{{ channel.id }}" {% if channel.id|string == chan_id %}selected{% endif %}>#{{ channel.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Tin nhắn/coin</label><input type="number" class="form-control-poetic" name="channel_rate_messages[]" value="{{ rates.MESSAGES_PER_COIN or '' }}"></div>
                                <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Reaction/coin</label><input type="number" class="form-control-poetic" name="channel_rate_reactions[]" value="{{ rates.REACTIONS_PER_COIN or '' }}"></div>
                            </div>
                            <div class="dynamic-row-actions"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="poetic-button poetic-button-success" style="margin-top: 1rem;" onclick="addChannelRate()">Thêm</button>
                </div>

                <div class="tab-pane" id="customrole">
                     <h5 class="form-section-title">Cài đặt Role Tùy Chỉnh (cho Booster)</h5>
                     <div class="form-grid">
                         <div class="form-group-poetic"><label class="form-label-poetic">Số lần boost tối thiểu</label><input type="number" class="form-control-poetic" name="CUSTOM_ROLE_CONFIG[MIN_BOOST_COUNT]" value="{{ config.CUSTOM_ROLE_CONFIG.get('MIN_BOOST_COUNT', 2) }}"></div>
                         <div class="form-group-poetic"><label class="form-label-poetic">Giá (coin)</label><input type="number" class="form-control-poetic" name="CUSTOM_ROLE_CONFIG[PRICE]" value="{{ config.CUSTOM_ROLE_CONFIG.get('PRICE', 1000) }}"></div>
                    </div>
                </div>

                <div class="tab-pane" id="qna">
                    <h5 class="form-section-title">Câu hỏi thường gặp</h5>
                    <div id="qna-container">
                        {% for item in config.get('QNA_DATA', []) %}
                        <div class="dynamic-row qna-row">
                            <div class="qna-row-header">
                                <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Câu hỏi (menu)</label><input type="text" class="form-control-poetic" name="qna_label[]" value="{{ item.label }}"></div>
                                <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Mô tả ngắn</label><input type="text" class="form-control-poetic" name="qna_description[]" value="{{ item.description or '' }}"></div>
                                <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Emoji</label><input type="text" class="form-control-poetic" name="qna_emoji[]" value="{{ item.emoji or '' }}"></div>
                            </div>
                            <div class="qna-row-body">
                                <div class="form-group-poetic" style="margin:0; flex-grow:1;"><label class="form-label-poetic">Tiêu đề trả lời</label><input type="text" class="form-control-poetic" name="qna_answer_title[]" value="{{ item.answer_title or '' }}"></div>
                                <div class="dynamic-row-actions"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div>
                            </div>
                            <div class="form-group-poetic" style="margin:0; width: 100%;"><label class="form-label-poetic">Nội dung trả lời</label><textarea class="form-control-poetic" name="qna_answer_description[]" rows="3">{{ item.answer_description or '' }}</textarea></div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="poetic-button poetic-button-success" style="margin-top:1rem;" onclick="addQnA()">Thêm Q&A</button>
                </div>
            </div>
            
            <div class="form-actions">
                <a href="{{ url_for('index') }}" class="poetic-button poetic-button-secondary">Hủy</a>
                <button type="submit" name="submit" class="poetic-button poetic-button-primary">Lưu thay đổi</button>
            </div>
        </form>
    </div>
</div>

<!-- templates cho js -->
<template id="category-rate-template">
    <div class="dynamic-row rates-row">
        <div class="dynamic-row-content">
            <div class="form-group-poetic" style="margin:0;">
                <label class="form-label-poetic">Danh mục</label>
                <select class="form-select-poetic" name="category_rate_id[]">
                    <option value="">-- Chọn danh mục --</option>
                    {% for category in category_channels %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Tin nhắn/coin</label><input type="number" class="form-control-poetic" name="category_rate_messages[]"></div>
            <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Reaction/coin</label><input type="number" class="form-control-poetic" name="category_rate_reactions[]"></div>
        </div>
        <div class="dynamic-row-actions"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div>
    </div>
</template>

<template id="channel-rate-template">
    <div class="dynamic-row rates-row">
        <div class="dynamic-row-content">
            <div class="form-group-poetic" style="margin:0;">
                <label class="form-label-poetic">Kênh</label>
                <select class="form-select-poetic" name="channel_rate_id[]">
                    <option value="">-- Chọn kênh --</option>
                    {% for channel in rateable_channels %}
                    <option value="{{ channel.id }}">#{{ channel.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Tin nhắn/coin</label><input type="number" class="form-control-poetic" name="channel_rate_messages[]"></div>
            <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Reaction/coin</label><input type="number" class="form-control-poetic" name="channel_rate_reactions[]"></div>
        </div>
        <div class="dynamic-row-actions"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div>
    </div>
</template>

<script>
// xu ly tab nav
document.addEventListener('DOMContentLoaded', function () {
    const tabButtons = document.querySelectorAll('.config-nav-button');
    const tabPanes = document.querySelectorAll('.tab-content .tab-pane');

    tabButtons.forEach(button => {
        button.addEventListener('click', function () {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            const targetId = this.getAttribute('data-target');
            tabPanes.forEach(pane => pane.classList.remove('active'));
            document.querySelector(targetId).classList.add('active');
        });
    });
});

// ham js
function removeRow(button) { button.closest('.dynamic-row').remove(); }

function addCategoryRate() { 
    const template = document.getElementById('category-rate-template');
    const clone = template.content.cloneNode(true);
    document.getElementById('category-rates-container').appendChild(clone);
}

function addChannelRate() { 
    const template = document.getElementById('channel-rate-template');
    const clone = template.content.cloneNode(true);
    document.getElementById('channel-rates-container').appendChild(clone);
}

function addQnA() { 
    const html = `
    <div class="dynamic-row qna-row">
        <div class="qna-row-header">
            <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Câu hỏi (menu)</label><input type="text" class="form-control-poetic" name="qna_label[]"></div>
            <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Mô tả ngắn</label><input type="text" class="form-control-poetic" name="qna_description[]"></div>
            <div class="form-group-poetic" style="margin:0;"><label class="form-label-poetic">Emoji</label><input type="text" class="form-control-poetic" name="qna_emoji[]"></div>
        </div>
        <div class="qna-row-body">
            <div class="form-group-poetic" style="margin:0; flex-grow:1;"><label class="form-label-poetic">Tiêu đề trả lời</label><input type="text" class="form-control-poetic" name="qna_answer_title[]"></div>
            <div class="dynamic-row-actions"><button type="button" class="poetic-button poetic-button-danger" onclick="removeRow(this)">Xóa</button></div>
        </div>
        <div class="form-group-poetic" style="margin:0; width: 100%;"><label class="form-label-poetic">Nội dung trả lời</label><textarea class="form-control-poetic" name="qna_answer_description[]" rows="3"></textarea></div>
    </div>`;
    document.getElementById('qna-container').insertAdjacentHTML('beforeend', html);
}
</script>
{% endblock %}